// ==============================
// DATABASE & CLIENT
// ==============================
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ==============================
// ENUMS
// ==============================
enum OrgRole {
  OWNER
  ADMIN
  HR
  MANAGER
  EMPLOYEE
  GUEST
}

enum SeatAuditAction {
  ASSIGN
  UNASSIGN
  MOVE
  LOCK
  UNLOCK
}

enum ExportType {
  SEAT_ALLOCATION
  SEAT_AUDIT
}

// ==============================
// CORE DOMAIN: ORGANIZATIONS
// ==============================
model Organization {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  domain      String?
  isActive    Boolean   @default(true)
  trialEndsAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  members    OrganizationMember[]
  buildings  Building[]
  exportLogs ExportLog[]
}

// ==============================
// USERS (GLOBAL IDENTITY)
// ==============================
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  fullName     String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  memberships     OrganizationMember[]
  seatAssignments SeatAssignment[]

  auditLogs        SeatAuditLog[] @relation("AuditUser")
  seatAuditActions SeatAuditLog[] @relation("SeatAuditActor")

  exportLogs ExportLog[] @relation("UserExports")
}

// ==============================
// ORG ↔ USER JOIN (ROLES LIVE HERE)
// ==============================
model OrganizationMember {
  id             String   @id @default(uuid())
  userId         String
  organizationId String
  role           OrgRole
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
}

// ==============================
// PHYSICAL STRUCTURE
// ==============================
model Building {
  id             String   @id @default(uuid())
  name           String
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  floors       Floor[]
}

model Floor {
  id         String   @id @default(uuid())
  name       String
  buildingId String
  imageUrl   String
  width      Int
  height     Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  seats    Seat[]

  @@unique([name, buildingId])
}

model Seat {
  id        String   @id @default(uuid())
  seatCode  String
  x         Float
  y         Float
  isLocked  Boolean  @default(false)
  floorId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  floor       Floor            @relation(fields: [floorId], references: [id], onDelete: Cascade)
  assignments SeatAssignment[]

  // ✅ correct audit relation
  auditLogs SeatAuditLog[]

  @@unique([seatCode, floorId])
}

// ==============================
// SEAT ASSIGNMENTS
// ==============================
model SeatAssignment {
  id           String    @id @default(uuid())
  userId       String
  seatId       String
  assignedAt   DateTime  @default(now())
  unassignedAt DateTime?
  isActive     Boolean   @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  seat Seat @relation(fields: [seatId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([seatId])
}

// ==============================
// SEAT AUDIT LOG (APPEND-ONLY)
// ==============================
model SeatAuditLog {
  id       String  @id @default(uuid())
  seatId   String
  seatCode String
  userId   String? // affected user (no hard relation)
  actorId  String // admin who performed action

  action     SeatAuditAction
  fromSeatId String?
  toSeatId   String?

  isLockedBefore Boolean?
  isLockedAfter  Boolean?

  createdAt DateTime @default(now())

  // Relations
  seat  Seat  @relation(fields: [seatId], references: [id], onDelete: Cascade)
  user  User? @relation("AuditUser", fields: [userId], references: [id], onDelete: Cascade)
  actor User  @relation("SeatAuditActor", fields: [actorId], references: [id], onDelete: Cascade)
}

// ==============================
// EXPORT LOG
// ==============================
model ExportLog {
  id             String     @id @default(uuid())
  organizationId String
  exportType     ExportType
  exportedAt     DateTime   @default(now())
  exportedById   String

  // ✅ ADD THIS
  s3Key          String?

  organization Organization @relation(fields: [organizationId], references: [id])
  exportedBy   User         @relation("UserExports", fields: [exportedById], references: [id])

  @@index([organizationId, exportType])
}
