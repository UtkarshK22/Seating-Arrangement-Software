generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id          String               @id @default(uuid())
  name        String
  slug        String               @unique
  domain      String?
  isActive    Boolean              @default(true)
  trialEndsAt DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  buildings   Building[]
  exportLogs  ExportLog[]
  members     OrganizationMember[]
}

model User {
  id               String               @id @default(uuid())
  email            String               @unique
  passwordHash     String
  fullName         String
  isActive         Boolean              @default(true)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  exportLogs       ExportLog[]          @relation("UserExports")
  memberships      OrganizationMember[]
  seatAssignments  SeatAssignment[]
  seatAuditActions SeatAuditLog[]       @relation("SeatAuditActor")
  auditLogs        SeatAuditLog[]       @relation("AuditUser")
}

model OrganizationMember {
  id             String       @id @default(uuid())
  userId         String
  organizationId String
  role           OrgRole
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
}

model Building {
  id             String       @id @default(uuid())
  name           String
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  floors         Floor[]
}

model Floor {
  id         String   @id @default(uuid())
  name       String
  buildingId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  height     Int
  imageUrl   String
  width      Int
  building   Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  seats      Seat[]

  @@unique([name, buildingId])
}

model Seat {
  id          String           @id @default(uuid())
  seatCode    String
  x           Float
  y           Float
  isLocked    Boolean          @default(false)
  floorId     String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  floor       Floor            @relation(fields: [floorId], references: [id], onDelete: Cascade)
  assignments SeatAssignment[]
  auditLogs   SeatAuditLog[]

  @@unique([seatCode, floorId])
}

model SeatAssignment {
  id           String    @id @default(uuid())
  userId       String
  seatId       String
  assignedAt   DateTime  @default(now())
  unassignedAt DateTime?
  isActive     Boolean   @default(true)
  seat         Seat      @relation(fields: [seatId], references: [id], onDelete: Cascade)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([seatId])
}

model SeatAuditLog {
  id             String          @id @default(uuid())
  seatId         String
  seatCode       String
  userId         String?
  actorId        String
  action         SeatAuditAction
  fromSeatId     String?
  toSeatId       String?
  isLockedBefore Boolean?
  isLockedAfter  Boolean?
  createdAt      DateTime        @default(now())
  actor          User            @relation("SeatAuditActor", fields: [actorId], references: [id], onDelete: Cascade)
  seat           Seat            @relation(fields: [seatId], references: [id], onDelete: Cascade)
  user           User?           @relation("AuditUser", fields: [userId], references: [id], onDelete: Cascade)
}

model ExportLog {
  id             String       @id @default(uuid())
  organizationId String
  exportType     ExportType
  exportedAt     DateTime     @default(now())
  exportedById   String
  s3Key          String?
  exportedBy     User         @relation("UserExports", fields: [exportedById], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, exportType])
}

enum OrgRole {
  OWNER
  ADMIN
  HR
  MANAGER
  EMPLOYEE
  GUEST
}

enum SeatAuditAction {
  ASSIGN
  UNASSIGN
  MOVE
  LOCK
  UNLOCK
}

enum ExportType {
  SEAT_ALLOCATION
  SEAT_AUDIT
}
